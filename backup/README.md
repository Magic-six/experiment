# 拉格朗日安全插值协议

这个项目是对拉格朗日安全多方插值协议的重构实现，支持多个参与方进行安全的拉格朗日插值计算。该项目特别添加了对**高延迟、低带宽（WAN/IoT）环境**的测试支持，用于证明该协议在特定网络条件下的优势。

## 项目结构

- `main.py`: 主程序入口和测试函数
- `protocol.py`: 三方安全计算协议实现
- `protocol_extension.py`: 四方安全计算和插值主函数实现
- `participant.py`: 参与方类定义
- `participant_enhanced.py`: 支持网络模拟的增强参与方类
- `protocol_factory.py`: 参与方实例创建工厂
- `utils.py`: 辅助函数和工具方法
- `config.py`: 配置参数
- `network_simulator.py`: 网络环境模拟模块
- `network_test.py`: 网络环境测试功能实现
- `run_network_tests.py`: 运行网络测试的命令行工具

## 功能特点

1. 模块化设计，提高代码可读性和可维护性
2. 支持任意数量的参与方(3-30)进行安全计算
3. 优化的异步通信实现
4. 健壮的错误处理和资源管理
5. 详细的日志记录和性能统计
6. 网络环境模拟功能，支持多种网络条件下的测试
7. 自动化测试和结果可视化

## 运行方法

### 基本运行

```bash
python main.py [参与方数量]
```

### 运行测试

```bash
python main.py [参与方数量] test
```

### 网络环境测试

#### 标准测试

```bash
python run_network_tests.py --networks local wan iot --parties 3 5 7 --repeats 3 --output results.json
```

可选参数:
- `--networks`: 要测试的网络环境列表 (可用选项: local, lan, wan, poor_wan, satellite, iot, mobile_4g, mobile_5g)
- `--parties`: 要测试的参与方数量列表
- `--repeats`: 每个配置的重复测试次数
- `--output`: 结果输出文件名

#### 高性能优化测试

```bash
python run_network_tests_optimized.py --networks local wan --parties 3 5 --repeats 2 --parallel --max-parallel 2 --optimize-speed --compression --timeout 180
```

高性能测试器特有参数:
- `--parallel`: 启用并行测试执行
- `--max-parallel`: 最大并行任务数
- `--optimize-speed`: 优先速度，减少延迟
- `--compression`: 启用数据压缩
- `--timeout`: 每个测试的超时时间（秒）

## 说明

- 实际协议中使用随机数模拟0分享和1分享份额，足以模拟协议运行过程
- 如需使用真实的0分享1分享协议，可以参考zero_one_share模块
- 每个三元组/四元组的计算已实现并行化，显著提升了多参与方场景下的性能

## 网络环境模拟

项目实现了一个网络环境模拟器，可以模拟不同网络条件下的通信特性:

- **延迟**: 模拟网络传输延迟
- **丢包率**: 模拟网络数据包丢失
- **带宽限制**: 模拟网络带宽限制
- **数据压缩**: 模拟通信数据压缩
- **缓存机制**: 模拟网络缓存效应

预定义的网络环境包括:

| 环境名称 | 延迟范围 | 丢包率 | 带宽 |
|---------|---------|-------|------|
| local | 1-5 ms | 0% | 无限制 |
| lan | 5-20 ms | 0.1% | 100 Mbps |
| wan | 50-200 ms | 1% | 10 Mbps |
| poor_wan | 100-500 ms | 5% | 1 Mbps |
| satellite | 500-1000 ms | 3% | 512 kbps |
| iot | 200-800 ms | 8% | 100 kbps |
| mobile_4g | 50-150 ms | 2% | 5 Mbps |
| mobile_5g | 10-50 ms | 0.5% | 50 Mbps |

## 测试输出

网络环境测试会生成以下输出:

1. **JSON 结果文件**: 包含所有测试配置的详细结果数据
2. **运行时间比较图**: 比较不同网络环境下的协议运行时间
3. **成功率图**: 比较不同网络环境下的协议成功率
4. **通信量图**: 比较不同网络环境下的协议通信量
5. **热图**: 不同网络环境和参与方数量组合的性能热图

## 性能优化

项目包含多项性能优化措施：

1. **并行计算**: 通过`asyncio.gather`并行执行所有三元组和四元组计算
2. **自适应超时**: 根据网络条件自动调整超时时间
3. **重试机制**: 实现智能重试，提高成功率
4. **数据压缩**: 可选数据压缩，减少传输延迟
5. **缓存模拟**: 模拟网络缓存机制，减少重复传输
6. **并行测试**: 支持并行执行多个测试场景
7. **超时控制**: 增加每个测试的超时控制，避免漏洞测试
8. **限流控制**: 实现带宽使用的限流控制

使用优化测试脚本可显著减少测试时间（通常提升、50%以上），并且对复杂的多参与方、恶劣网络环境测试场景有更好的成功率。
